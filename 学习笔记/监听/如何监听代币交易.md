# 如何监听代币交易

## 技术栈

- **Etherscan API**: 区块链浏览器提供的 API 服务
  - `tokentx`: 获取指定代币合约的转账交易记录
  - 支持分页、排序、区块范围过滤

## 实现概览

- 用 **fetch** 调用 Etherscan API 的 `tokentx` 接口，获取代币合约的转账交易记录
- 通过 `contractaddress` 参数指定要查询的代币合约地址（如 USDT）
- 通过 `sort` 参数控制返回结果的排序方式（`desc` 表示最新的在前）

## 核心概念

### 代币交易和普通交易的区别

- **普通交易（ETH 转账）**：直接发送 ETH，不涉及智能合约
- **代币交易（ERC20 转账）**：调用代币合约的 `transfer` 函数，合约内部记录余额变化

### 为什么需要单独的 API？

普通的 `txlist` 接口只能查询 ETH 转账。代币转账是通过合约实现的，需要使用专门的 `tokentx` 接口来查询。

### 交易记录包含哪些信息？

| 字段 | 说明 |
|------|------|
| `hash` | 交易哈希，唯一标识一笔交易 |
| `from` | 发送方地址 |
| `to` | 接收方地址 |
| `value` | 转账金额（最小单位，需要根据代币精度转换） |
| `timeStamp` | 交易时间（Unix 时间戳，秒） |
| `blockNumber` | 交易所在区块号 |
| `gasUsed` | 实际消耗的 Gas |
| `gasPrice` | Gas 价格（wei 单位） |

## 核心实现详情

### 1. 调用 Etherscan API 获取代币交易

```typescript
// 构建 API 请求 URL
const params = new URLSearchParams({
  chainid: "1",                    // 以太坊主网
  module: "account",               // account 模块提供交易查询
  action: "tokentx",               // tokentx 接口专门查询代币交易
  address: usdtContractAddress,    // 代币合约地址
  contractaddress: usdtContractAddress, // 同上，用于过滤特定代币
  page: "1",                       // 分页页码
  offset: "10",                    // 每页记录数
  sort: "desc",                    // 按时间倒序（最新的在前）
  apikey: "YOUR_API_KEY",          // Etherscan API Key
});

const response = await fetch(
  `https://api.etherscan.io/v2/api?${params.toString()}`
);
const result = await response.json();

// 返回数据结构：
// {
//   "status": "1",
//   "message": "OK",
//   "result": [
//     {
//       "hash": "0x...",           // 交易哈希
//       "from": "0x...",           // 发送方
//       "to": "0x...",             // 接收方
//       "value": "1000000000",     // 金额（最小单位）
//       "timeStamp": "1702234567", // 时间戳
//       "blockNumber": "21234567", // 区块号
//       "gasUsed": "65000",        // Gas 消耗
//       "gasPrice": "20000000000"  // Gas 价格（wei）
//     },
//     ...
//   ]
// }
```

## 常见问题

### 如何查询特定地址的代币交易？

将 `address` 参数设置为要查询的钱包地址，`contractaddress` 设置为代币合约地址：

```typescript
const params = new URLSearchParams({
  module: "account",
  action: "tokentx",
  address: walletAddress,           // 钱包地址
  contractaddress: usdtContractAddress, // USDT 合约地址
  // ...
});
```

### 为什么有时候查询不到数据？

1. **区块未确认**：最新的交易可能还未被 Etherscan 索引
2. **参数错误**：检查合约地址是否正确
3. **API 限制**：免费 API 有请求频率限制，过于频繁会被限流