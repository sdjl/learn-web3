# 如何查询交易记录

## 技术栈

- **Wagmi**: React Hooks 库，提供 `useAccount` Hook 获取钱包地址和链信息
- **@tanstack/react-query**: 数据获取和状态管理库，提供 `useQuery` Hook 管理异步数据
- **Viem**: 以太坊工具库，提供 `formatEther` 函数格式化金额显示
- **Etherscan API V2**: 区块链浏览器 API，提供统一的交易历史查询接口

## 实现概览

- 用 **Wagmi** 的 `useAccount` Hook 获取钱包地址和当前链信息
- 用 **@tanstack/react-query** 的 `useQuery` Hook 管理交易数据的获取、加载状态和错误处理
- 用 **Etherscan API V2** 的 `txlist` 接口查询指定地址的交易历史记录
- 用 **Viem** 的 `formatEther` 函数将 BigInt 类型的 wei 转换为可读的 ETH 字符串

## 核心实现详情

### 1. 创建 Server Action 获取交易数据

```typescript
"use server";

export async function getTransactions(address: string, chainId: number) {
  // 构建 Etherscan API V2 请求参数
  const params = new URLSearchParams({
    chainid: chainId.toString(), // 链 ID
    module: "account", // 查询账户相关数据
    action: "txlist", // 获取交易列表
    address: address, // 要查询的地址
    sort: "desc", // 按时间倒序排列
  });

  // 调用 Etherscan API
  const apiUrl = `https://api.etherscan.io/v2/api?${params.toString()}`;
  const response = await fetch(apiUrl);
  const data = await response.json();

  // 返回交易列表
  return data.result || [];
}
```

### 2. 使用 React Query 查询交易数据

```typescript
"use client";

import { useQuery } from "@tanstack/react-query";
import { useAccount } from "wagmi";
import { formatEther } from "viem";
import { getTransactions } from "../actions";

export function TransactionList() {
  // 获取钱包地址和当前链信息
  const { address, chain } = useAccount();

  // 使用 useQuery 获取交易数据
  const { data, isLoading } = useQuery({
    // 查询键，包含地址和链 ID，当这些值变化时会重新查询
    queryKey: ["transactions", address, chain?.id],
    // 查询函数，调用 Server Action 获取交易数据
    queryFn: () => getTransactions(address!, chain!.id),
    // 仅在地址和链 ID 都存在时启用查询
    enabled: Boolean(address && chain?.id),
  });

  const transactions = data || [];

  // 格式化金额：将 wei（字符串）转换为 BigInt，再格式化为 ETH
  const value = formatEther(BigInt(transactions[0]?.value || "0"));
}
```
