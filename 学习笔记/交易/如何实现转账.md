# 如何实现转账

## 技术栈

- **Wagmi**: React Hooks 库，提供 `useSendTransaction` Hook 发送交易、`useWaitForTransactionReceipt` Hook 等待交易确认
- **Viem**: 以太坊工具库，提供 `parseEther` 函数将 ETH 转换为 wei、`isAddress` 函数验证地址格式

## 实现概览

- 用 **Wagmi** 的 `useSendTransaction` Hook 发送转账交易
- 用 **Wagmi** 的 `useWaitForTransactionReceipt` Hook 等待交易确认并获取交易状态
- 用 **Viem** 的 `parseEther` 函数将用户输入的 ETH 金额转换为 wei 单位
- 用 **Viem** 的 `isAddress` 函数验证接收地址格式
- 用 **Wagmi** 的 `useBalance` Hook 查询余额并验证余额是否足够

## 核心实现详情

### 1. 发送转账交易 (`app/transfer/components/Form.tsx`)

```typescript
import { useSendTransaction, useWaitForTransactionReceipt } from "wagmi";
import { parseEther, isAddress } from "viem";

export function Form() {
  const [toAddress, setToAddress] = useState("");
  const [amount, setAmount] = useState("");

  // 发送交易
  const {
    data: hash,
    sendTransaction,
    isPending,
    error,
  } = useSendTransaction();

  // 等待交易确认
  const { isLoading: isConfirming, isSuccess: isConfirmed } =
    useWaitForTransactionReceipt({
      hash,
    });

  const handleTransfer = async (e: React.FormEvent) => {
    e.preventDefault();

    // 验证地址格式
    if (!isAddress(toAddress)) {
      alert("请输入有效的以太坊地址");
      return;
    }

    // 发送交易
    sendTransaction({
      to: toAddress as `0x${string}`,
      value: parseEther(amount),
    });
  };

  return (
    <form onSubmit={handleTransfer}>
      <input
        value={toAddress}
        onChange={(e) => setToAddress(e.target.value)}
        placeholder="0x..."
      />
      <input
        type="number"
        value={amount}
        onChange={(e) => setAmount(e.target.value)}
        placeholder="0.0"
      />
      <button type="submit" disabled={isPending || isConfirming}>
        {isPending ? "等待钱包确认..." : "发送交易"}
      </button>
    </form>
  );
}
```

### 2. 验证余额和交易状态 (`app/transfer/components/Form.tsx`)

```typescript
import { useBalance } from "wagmi";
import { formatEther } from "viem";

export function Form() {
  const { address } = useAccount();
  const [amount, setAmount] = useState("");

  // 查询余额
  const { data: balanceData } = useBalance({
    address,
    query: { enabled: Boolean(address) },
  });

  const handleTransfer = async (e: React.FormEvent) => {
    e.preventDefault();

    // 验证余额是否足够
    if (balanceData && balanceData.value) {
      const balanceInEther = parseFloat(formatEther(balanceData.value));
      const amountNum = parseFloat(amount);
      if (balanceInEther < amountNum) {
        alert("余额不足");
        return;
      }
    }

    // 发送交易...
  };

  // 显示交易状态
  return (
    <>
      {isPending && <div>交易已提交，等待钱包确认...</div>}
      {isConfirming && <div>交易已确认，等待区块确认...</div>}
      {isConfirmed && (
        <div>
          <p>交易成功！</p>
          <p>交易哈希: {hash}</p>
        </div>
      )}
    </>
  );
}
```
