# 如何切换链并查询余额

## 技术栈

- **Wagmi**: React Hooks 库，提供 `useAccount`、`useBalance`、`useSwitchChain` 等 Hook
- **Viem**: 以太坊工具库，提供 `formatEther` 函数格式化余额显示

## 实现概览

- 用 **Wagmi** 的 `useAccount` Hook 获取钱包连接状态、地址和当前链信息
- 用 **Wagmi** 的 `useSwitchChain` Hook 实现链切换功能
- 用 **Wagmi** 的 `useBalance` Hook 查询当前连接链的余额
- 用 **Wagmi** 的 `useBalance` Hook 的 `chainId` 参数查询指定链的余额（无需切换链）
- 用 **Wagmi** 的 `useBalance` Hook 返回的 `refetch` 函数手动刷新余额
- 用 **Viem** 的 `formatEther` 函数将 BigInt 类型的 wei 转换为可读的 ETH 字符串
- 用 **React** 的 `useState` 管理选中的链 ID 状态
- 用 **React** 的 `useMemo` 同步当前链 ID，避免在 effect 中 setState

## 核心实现详情

### 1. 主页面结构 (`app/chain-balance/page.tsx`)

```typescript
"use client";

import { useAccount } from "wagmi";
import { useState, useMemo } from "react";
import { ChainSelector } from "./components/ChainSelector";
import { BalanceDisplay } from "./components/BalanceDisplay";
import { EmptyState } from "./components/EmptyState";

export default function ChainBalancePage() {
  // 获取钱包连接状态和当前链信息
  const { chain, isConnected, address } = useAccount();

  // 当前选择的链（用于查询余额），默认使用当前连接的链
  const [selectedChainId, setSelectedChainId] = useState<number | undefined>(
    chain?.id
  );

  // 当链切换时，同步更新选中的链 ID（使用 useMemo 避免在 effect 中 setState）
  const currentChainId = useMemo(() => chain?.id, [chain?.id]);
  const effectiveSelectedChainId = selectedChainId ?? currentChainId;

  return (
    <main>
      {/* 仅在钱包已连接时显示链切换和余额查询区域 */}
      {isConnected && address && (
        <section>
          <ChainSelector
            selectedChainId={effectiveSelectedChainId}
            onSelectChain={(chainId) => {
              setSelectedChainId(chainId);
            }}
          />
          <BalanceDisplay selectedChainId={effectiveSelectedChainId} />
        </section>
      )}

      {/* 仅在钱包未连接时显示空状态 */}
      {!isConnected && <EmptyState />}
    </main>
  );
}
```

### 2. 链选择器组件 (`app/chain-balance/components/ChainSelector.tsx`)

```typescript
"use client";

import { useAccount, useSwitchChain } from "wagmi";
import { mainnet, sepolia, Chain } from "wagmi/chains";

const supportedChains: Chain[] = [mainnet, sepolia];

interface ChainSelectorProps {
  selectedChainId: number | undefined;
  onSelectChain: (chainId: number) => void;
}

export function ChainSelector({
  selectedChainId,
  onSelectChain,
}: ChainSelectorProps) {
  // 获取当前连接的链和切换链的功能
  const { chain } = useAccount();
  const { switchChain, isPending: isSwitching } = useSwitchChain();

  // 处理链切换
  const handleSwitchChain = async (targetChainId: number) => {
    try {
      await switchChain({ chainId: targetChainId });
      onSelectChain(targetChainId);
    } catch (error) {
      console.error("切换链失败:", error);
    }
  };

  // 处理链选择
  const handleSelectChain = (chainId: number) => {
    if (chain?.id === chainId) {
      // 如果已经是当前链，只更新选择状态
      onSelectChain(chainId);
    } else {
      // 如果不是当前链，尝试切换
      handleSwitchChain(chainId);
    }
  };

  return (
    <div>
      {/* 链选择按钮 */}
      {supportedChains.map((supportedChain) => {
        const isCurrentChain = chain?.id === supportedChain.id;
        const isSelected = selectedChainId === supportedChain.id;

        return (
          <button
            key={supportedChain.id}
            onClick={() => handleSelectChain(supportedChain.id)}
            disabled={isSwitching}
          >
            {supportedChain.name}
            {isCurrentChain && " (当前)"}
            {isSelected && !isCurrentChain && " (已选择)"}
          </button>
        );
      })}

      {/* 切换链状态提示 */}
      {isSwitching && (
        <div>正在切换链，请在钱包中确认...</div>
      )}
    </div>
  );
}
```

### 3. 余额显示组件 (`app/chain-balance/components/BalanceDisplay.tsx`)

```typescript
"use client";

import { useAccount, useBalance } from "wagmi";
import { mainnet, sepolia, Chain } from "wagmi/chains";
import { formatEther } from "viem";

const supportedChains: Chain[] = [mainnet, sepolia];

interface BalanceDisplayProps {
  selectedChainId: number | undefined;
}

export function BalanceDisplay({ selectedChainId }: BalanceDisplayProps) {
  // 获取钱包地址和当前连接的链
  const { address, chain, isConnected } = useAccount();

  // 查询当前连接链的余额
  const {
    data: currentBalanceData,
    isLoading: isCurrentBalanceLoading,
    refetch: refetchCurrentBalance,
  } = useBalance({
    address,
    query: { enabled: Boolean(address && isConnected) },
  });

  // 查询指定链的余额（如果选择了不同的链）
  const {
    data: selectedBalanceData,
    isLoading: isSelectedBalanceLoading,
    refetch: refetchSelectedBalance,
  } = useBalance({
    address,
    chainId: selectedChainId, // 关键：通过 chainId 参数查询指定链的余额
    query: {
      enabled: Boolean(
        address && selectedChainId && selectedChainId !== chain?.id
      ),
    },
  });

  // 处理刷新余额
  const handleRefreshBalance = () => {
    if (selectedChainId === chain?.id) {
      refetchCurrentBalance();
    } else {
      refetchSelectedBalance();
    }
  };

  return (
    <div>
      {/* 当前链余额显示 */}
      <div>
        <span>当前链余额 ({chain?.name || "未知"})</span>
        <div>
          {isCurrentBalanceLoading ? (
            <span>查询中...</span>
          ) : currentBalanceData?.value ? (
            `${formatEther(currentBalanceData.value)} ${
              currentBalanceData.symbol || ""
            }`
          ) : (
            <span>--</span>
          )}
        </div>
      </div>

      {/* 选中链余额显示（如果选择了不同的链） */}
      {selectedChainId && selectedChainId !== chain?.id && (
        <div>
          <span>
            选中链余额 (
            {supportedChains.find((c) => c.id === selectedChainId)?.name ||
              "未知"}
            )
          </span>
          <div>
            {isSelectedBalanceLoading ? (
              <span>查询中...</span>
            ) : selectedBalanceData?.value ? (
              `${formatEther(selectedBalanceData.value)} ${
                selectedBalanceData.symbol || ""
              }`
            ) : (
              <span>--</span>
            )}
          </div>
        </div>
      )}

      {/* 刷新余额按钮 */}
      <button
        onClick={handleRefreshBalance}
        disabled={
          isCurrentBalanceLoading || isSelectedBalanceLoading || !isConnected
        }
      >
        {isCurrentBalanceLoading || isSelectedBalanceLoading
          ? "刷新中..."
          : "刷新余额"}
      </button>
    </div>
  );
}
```

### 4. 空状态组件 (`app/chain-balance/components/EmptyState.tsx`)

```typescript
export function EmptyState() {
  return (
    <div>
      <p>请先连接钱包以使用链切换和余额查询功能</p>
    </div>
  );
}
```
